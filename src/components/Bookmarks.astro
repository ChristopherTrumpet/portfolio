---
import { API_URL } from "astro:env/server";
import Bookmark from "../components/Bookmark.astro";

const response = await fetch(`${API_URL}/bookmarks`, {
  headers: { "User-Agent": "portfolio/1.0 (internal-fetch)" },
});
const bookmarks = await response.json();
---

<section class="flex flex-col lg:py-0 lg:justify-center">
  <div class="w-full h-full">
    <h2
      class="mb-4 font-serif text-xl lg:text-2xl font-normal tracking-tight text-zinc-800"
    >
      what i've been reading / watching...
    </h2>

    <div
      id="bookmark-list"
      class="dynamic-mask border-zinc-300 divide-y divide-zinc-300 max-h-[65vh] overflow-y-auto pr-3"
    >
      {bookmarks.map((b: any) => <Bookmark {...b} />)}
    </div>
  </div>
</section>

<style>
  .dynamic-mask {
    will-change:
      mask-image,
      -webkit-mask-image;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;

    --mask-top-color: black;
    --mask-top-stop: 0%;
    --mask-bottom-stop: 100%;
    --mask-bottom-color: black;

    mask-image: linear-gradient(
      to bottom,
      var(--mask-top-color) 0%,
      black var(--mask-top-stop),
      black var(--mask-bottom-stop),
      var(--mask-bottom-color) 100%
    );
    -webkit-mask-image: linear-gradient(
      to bottom,
      var(--mask-top-color) 0%,
      black var(--mask-top-stop),
      black var(--mask-bottom-stop),
      var(--mask-bottom-color) 100%
    );

    transition:
      --mask-top-stop 0.2s ease,
      --mask-bottom-stop 0.2s ease,
      --mask-top-color 0.2s ease,
      --mask-bottom-color 0.2s ease;
  }
</style>

<script>
  const updateMask = (el: HTMLElement) => {
    requestAnimationFrame(() => {
      const { scrollTop, scrollHeight, clientHeight } = el;

      const isScrollable = scrollHeight > clientHeight;
      const isAtTop = scrollTop <= 2;
      const isAtBottom =
        Math.ceil(scrollTop + clientHeight) >= scrollHeight - 2;

      // Top mask
      if (!isScrollable || isAtTop) {
        el.style.setProperty("--mask-top-color", "black");
        el.style.setProperty("--mask-top-stop", "0%");
      } else {
        el.style.setProperty("--mask-top-color", "transparent");
        el.style.setProperty("--mask-top-stop", "12%");
      }

      // Bottom mask
      if (!isScrollable || isAtBottom) {
        el.style.setProperty("--mask-bottom-color", "black");
        el.style.setProperty("--mask-bottom-stop", "100%");
      } else {
        el.style.setProperty("--mask-bottom-color", "transparent");
        el.style.setProperty("--mask-bottom-stop", "88%");
      }
    });
  };

  const container = document.getElementById("bookmark-list");

  if (container) {
    container.addEventListener("scroll", () => updateMask(container), {
      passive: true,
    });
    container.addEventListener("touchmove", () => updateMask(container), {
      passive: true,
    });

    updateMask(container);
    window.addEventListener("resize", () => updateMask(container));
  }
</script>
