---
import { API_URL } from "astro:env/server";
import BookmarkItem from "../components/BookmarkItem.astro";

const response = await fetch(`${API_URL}/bookmarks`, {
  headers: { "User-Agent": "portfolio/1.0 (internal-fetch)" },
});
const bookmarks = await response.json();
---

<section class="flex flex-col h-full px-6 py-16 lg:py-0 lg:justify-center">
  <div class="w-full max-w-2xl mx-auto">
    <h2
      class="mb-4 font-serif text-xl lg:text-2xl font-normal tracking-tight text-zinc-800"
    >
      what i've been reading / watching...
    </h2>

    <div
      id="bookmark-list"
      class="dynamic-mask border-zinc-300 divide-y divide-zinc-300 max-h-[65vh] overflow-y-auto pr-6"
    >
      {bookmarks.map((b: any) => <BookmarkItem {...b} />)}
    </div>
  </div>
</section>

<style>
  .dynamic-mask {
    --mask-top: black;
    --mask-top-stop: 0%;
    --mask-bottom-stop: 100%;
    --mask-bottom: black;

    mask-image: linear-gradient(
      to bottom,
      var(--mask-top) 0%,
      black var(--mask-top-stop),
      black var(--mask-bottom-stop),
      var(--mask-bottom) 100%
    );
    -webkit-mask-image: linear-gradient(
      to bottom,
      var(--mask-top) 0%,
      black var(--mask-top-stop),
      black var(--mask-bottom-stop),
      var(--mask-bottom) 100%
    );

    transition: all 0.3s ease;
  }
</style>

<script>
  const updateMask = (el: HTMLElement) => {
    const scrollTop = el.scrollTop;
    const scrollHeight = el.scrollHeight;
    const clientHeight = el.clientHeight;

    const isScrollable = scrollHeight > clientHeight;
    const isAtTop = scrollTop <= 0;
    const isAtBottom = Math.abs(scrollHeight - clientHeight - scrollTop) < 1;

    // Top mask
    if (!isScrollable || isAtTop) {
      el.style.setProperty("--mask-top", "black");
      el.style.setProperty("--mask-top-stop", "0%");
    } else {
      el.style.setProperty("--mask-top", "transparent");
      el.style.setProperty("--mask-top-stop", "20%");
    }

    // Bottom mask
    if (!isScrollable || isAtBottom) {
      el.style.setProperty("--mask-bottom", "black");
      el.style.setProperty("--mask-bottom-stop", "100%");
    } else {
      el.style.setProperty("--mask-bottom", "transparent");
      el.style.setProperty("--mask-bottom-stop", "80%");
    }
  };

  const container = document.getElementById("bookmark-list");

  if (container) {
    container.addEventListener("scroll", () => updateMask(container));

    // Check on load and resize
    updateMask(container);
    window.addEventListener("resize", () => updateMask(container));

    // MutationObserver handles cases where content loads late
    const observer = new MutationObserver(() => updateMask(container));
    observer.observe(container, { childList: true });
  }
</script>
